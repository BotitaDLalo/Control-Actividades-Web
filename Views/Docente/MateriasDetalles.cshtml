@{
    Layout = "~/Views/Shared/_LayoutDocente.cshtml";
    ViewBag.Title = "MateriasDetalles";
    Html.RenderPartial("~/Views/Docente/CrearActividadModal.cshtml");
    Html.RenderPartial("~/Views/Docente/crearAvisoMateriaModal.cshtml");

    int docenteId = ViewBag.DocenteId != null ? (int)ViewBag.DocenteId : 0;

    int materiaId = ViewBag.MateriaId != null ? (int)ViewBag.MateriaId : 0;

    int grupoId = ViewBag.GrupoId != null ? (int)ViewBag.GrupoId : 0;
}
<div id="docente-datos" data-docenteid="@docenteId"></div>
<div class="materia-container">
    <div class="materia-header" id="materiaHeader" style="background-color: #d63384;">
        <h1><span id="materiaNombre">Cargando...</span></h1>
        <div class="materia-info">
            <span>Código de clase: <strong id="codigoAcceso">Cargando...</strong></span>
            <i class="fas fa-copy copiar-icono" onclick="copiarCodigoAcceso()" title="Copiar código"></i>
        </div>
    </div>

    <nav class="materia-nav">
        <button class="tab-button active" onclick="cambiarSeccion('avisos')">Avisos</button>
        <button class="tab-button" onclick="cambiarSeccion('actividades')">Actividades</button>
        <button class="tab-button" onclick="abrirEntregables()">Entregables</button>
        <button class="tab-button" onclick="cambiarSeccion('alumnos')">Alumnos</button>
        <button class="tab-button" onclick="cambiarSeccion('configuracion')">Configuración</button>
    </nav>

    <div id="contenedor-dinamico" class="materia-content">
        <div id="seccion-avisos" class="seccion">
            <div class="dropdown">
                <button class="btn-crear">Crear ▼</button>
                <div class="dropdown-content">
                    <button class="misCursos-dropdown-item" data-bs-toggle="modal" data-bs-target="#crearAvisoMateriaModal">
                        Crear Aviso
                    </button>
                </div>

        <div id="seccion-entregables" class="seccion" style="display: none;">
            <p>Entregables — abre el modal para ver (aún sin contenido)</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#entregablesModal">Ver Entregables</button>
        </div>

        <div id="seccion-configuracion" class="seccion" style="display: none;">
            <h4>Configuración de la materia</h4>
            <div class="mb-3">
                <label class="form-label">Nombre de la materia</label>
                <input id="configNombre" class="form-control" />
            </div>
            <div class="mb-3">
                <label class="form-label">Descripción</label>
                <textarea id="configDescripcion" class="form-control"></textarea>
            </div>
            <button id="btnGuardarConfig" class="btn btn-success">Guardar</button>
        </div>
            </div>
            <div class="divider"></div>
            <div id="listaDeAvisosDeMateria"></div>
        </div>

        <div id="seccion-actividades" class="seccion" style="display: none;">
            <div class="dropdown">
                <button class="btn-crear">Crear ▼</button>
                <div class="dropdown-content">
                    <button class="misCursos-dropdown-item" data-bs-toggle="modal" data-bs-target="#crearActividadModal">
                        📋Crear Tarea
                    </button>
                </div>
            </div>
            <div class="divider"></div>
            <div id="listaActividadesDeMateria"></div>
        </div>

        <div id="seccion-alumnos" class="seccion" style="display: none;">
            <div class="container mt-3">
                <label for="buscarAlumno" class="form-label">Buscar alumno por correo:</label>
                <div class="input-group">
                    <input type="text" id="buscarAlumno" class="form-control" placeholder="Ingrese el correo del alumno..." autocomplete="off">
                    <button id="btnAsignarAlumno" class="btn btn-primary">Asignar Alumno</button>
                    
                    @if (User != null && User.IsInRole("Docente"))
                    {
                        <button id="btnImportarAlumnos" class="btn btn-success ms-2" title="Importar desde Excel"><i class="fas fa-file-excel" style="margin-right:8px"></i>Importar Alumnos</button>
                        <input type="file" id="fileImportarAlumnos" accept=".xlsx,.xls" style="display:none" />
                    }
                </div>
                <ul id="sugerenciasAlumnos" class="list-group mt-2"></ul>
            </div>
            <div id="listaAlumnosAsignados" class="mt-3"></div>
        </div>

        <div id="seccion-calificaciones" class="seccion" style="display: none;">
            <h2>Calificaciones</h2>
            <p>Notas de los estudiantes...</p>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let materiaIdGlobal = '@materiaId';
        let grupoIdGlobal = '@grupoId';
    </script>
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/docente")
    @Scripts.Render("~/bundles/docentegrupos")
    <script src="~/Scripts/Docente/Grupos/DetalleMateria.js"></script>
    <script src="~/Scripts/Docente/Grupos/scriptsAvisos.js"></script>
    <script src="~/Scripts/Docente/Grupos/scriptsAlumnos.js"></script>
    <script src="~/Scripts/Docente/Grupos/scriptsActividades.js"></script>
}

<div class="modal fade" id="entregablesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Entregables</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p>Aún no hay entregables configurados.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // abrir modal de entregables
    function abrirEntregables() {
        var modalEl = document.getElementById('entregablesModal');
        if (!modalEl) return;
        var modal = new bootstrap.Modal(modalEl);
        modal.show();
    }

    document.addEventListener('DOMContentLoaded', function () {
        var btnGuardar = document.getElementById('btnGuardarConfig');
        if (btnGuardar) {
            btnGuardar.addEventListener('click', async function () {
                var nombre = document.getElementById('configNombre').value.trim();
                var descripcion = document.getElementById('configDescripcion').value.trim();
                if (!nombre) { Swal.fire('Error', 'El nombre es requerido', 'error'); return; }
                try {
                    const resp = await fetch(`/Materias/ActualizarMateria?materiaId=${materiaIdGlobal}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ NombreMateria: nombre, Descripcion: descripcion })
                    });
                    if (resp.ok) { Swal.fire({ position: 'top-end', icon: 'success', title: 'Guardado', showConfirmButton: false, timer: 1500 }); }
                    else { Swal.fire('Error', 'No se pudo guardar', 'error'); }
                } catch (e) { console.error(e); Swal.fire('Error', 'No se pudo guardar', 'error'); }
            });
        }

        // rellenar inputs de configuracion con datos actuales
        fetch(`/Materias/ObtenerMateriaUnica?id=${materiaIdGlobal}`).then(r => r.json()).then(data => {
            if (data && data.NombreMateria) {
                document.getElementById('configNombre').value = data.NombreMateria || '';
                document.getElementById('configDescripcion').value = data.Descripcion || '';
            }
        }).catch(()=>{});
    });
</script>

@section Styles{
    @Styles.Render("~/Content/Docente/css")
}