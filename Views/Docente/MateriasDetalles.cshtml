@{
    Layout = "~/Views/Shared/_LayoutDocente.cshtml";
    ViewBag.Title = "MateriasDetalles";
    Html.RenderPartial("~/Views/Docente/CrearActividadModal.cshtml");
    Html.RenderPartial("~/Views/Docente/crearAvisoMateriaModal.cshtml");

    int docenteId = ViewBag.DocenteId != null ? (int)ViewBag.DocenteId : 0;

    int materiaId = ViewBag.MateriaId != null ? (int)ViewBag.MateriaId : 0;

    int grupoId = ViewBag.GrupoId != null ? (int)ViewBag.GrupoId : 0;
}
<div id="docente-datos" data-docenteid="@docenteId"></div>
<div class="materia-container">
    <div class="materia-header" id="materiaHeader" style="background-color: #d63384;">
        <h1><span id="materiaNombre">Cargando...</span></h1>
        <div class="materia-info">
            <span>Código de clase: <strong id="codigoAcceso">Cargando...</strong></span>
            <i class="fas fa-copy copiar-icono" onclick="copiarCodigoAcceso()" title="Copiar código"></i>
        </div>
    </div>

    <nav class="materia-nav">
        <button class="tab-button active" onclick="cambiarSeccion('avisos')">Avisos</button>
        <button class="tab-button" onclick="cambiarSeccion('actividades')">Actividades</button>
        <button class="tab-button" onclick="cambiarSeccion('entregables')">Entregables</button>
        <button class="tab-button" onclick="cambiarSeccion('alumnos')">Alumnos</button>
        <button class="tab-button" onclick="cambiarSeccion('configuracion')">Configuración</button>
    </nav>

    <div id="contenedor-dinamico" class="materia-content">
        <div id="seccion-avisos" class="seccion">
            <div class="dropdown">
                <button class="btn-crear">Crear ▼</button>
                <div class="dropdown-content">
                    <button class="misCursos-dropdown-item" data-bs-toggle="modal" data-bs-target="#crearAvisoMateriaModal">
                        Crear Aviso
                    </button>
                </div>
            </div>
            <div class="divider"></div>
            <div id="listaDeAvisosDeMateria"></div>
        </div>

        <div id="seccion-actividades" class="seccion" style="display: none;">
            <div class="dropdown">
                <button class="btn-crear">Crear ▼</button>
                <div class="dropdown-content">
                    <button class="misCursos-dropdown-item" data-bs-toggle="modal" data-bs-target="#crearActividadModal">
                        📋Crear Tarea
                    </button>
                </div>
            </div>
            <div class="divider"></div>
            <div id="listaActividadesDeMateria"></div>
        </div>

        <div id="seccion-entregables" class="seccion" style="display: none;">
            <div class="divider"></div>
            <!-- Contenedor donde se mostrarán los entregables en línea, similar a Avisos/Actividades -->
            <div id="listaEntregables" class="mt-2">
                <p class="text-muted">Aún no hay entregables configurados.</p>
            </div>
        </div>

        <div id="seccion-alumnos" class="seccion" style="display: none;">
            <div class="container mt-3">
                <label for="buscarAlumno" class="form-label">Buscar alumno por correo:</label>
                <div class="input-group">
                    <input type="text" id="buscarAlumno" class="form-control" placeholder="Ingrese el correo del alumno..." autocomplete="off">
                    <button id="btnAsignarAlumno" class="btn btn-primary">Asignar Alumno</button>
                    
                    @if (User != null && User.IsInRole("Docente"))
                    {
                        <button id="btnImportarAlumnos" class="btn btn-success ms-2" title="Importar desde Excel"><i class="fas fa-file-excel" style="margin-right:8px"></i>Importar Alumnos</button>
                        <input type="file" id="fileImportarAlumnos" accept=".xlsx,.xls" style="display:none" />
                    }
                </div>
                <ul id="sugerenciasAlumnos" class="list-group mt-2"></ul>
            </div>
            <div id="listaAlumnosAsignados" class="mt-3"></div>
        </div>

        <div id="seccion-configuracion" class="seccion" style="display: none;">
            <h4>Configuración de la materia</h4>

            <div class="mb-3">
                <label class="form-label">Editar Nombre</label>
                <div class="input-group">
                    <input id="configNombre" class="form-control" />
                    <button id="btnGuardarNombre" class="btn btn-primary" type="button" style="margin-left:2cm;">Guardar</button>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Editar Descripción</label>
                <div class="d-flex" style="gap:10px; align-items:flex-start;">
                    <textarea id="configDescripcion" class="form-control" style="min-height:120px; flex:1;"></textarea>
                    <button id="btnGuardarDescripcion" class="btn btn-primary" type="button" style="height:40px; align-self:flex-start; margin-left:2cm;">Guardar</button>
                </div>
            </div>

            <div class="d-flex" style="gap:10px;">
                <button id="btnCopiarMateria" class="btn btn-secondary">Copiar Materia</button>
                <button id="btnEliminarMateria" class="btn btn-danger">Eliminar Materia</button>
            </div>
        </div>

        <div id="seccion-calificaciones" class="seccion" style="display: none;">
            <h2>Calificaciones</h2>
            <p>Notas de los estudiantes...</p>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let materiaIdGlobal = '@materiaId';
        let grupoIdGlobal = '@grupoId';
        // Persist current materia/grupo selection so alumnos list can be restored
        try {
            if (materiaIdGlobal) localStorage.setItem('materiaIdSeleccionada', String(materiaIdGlobal));
            if (grupoIdGlobal && grupoIdGlobal !== '0') localStorage.setItem('grupoIdSeleccionado', String(grupoIdGlobal));
        } catch (e) { console.warn('No se pudo guardar materia/grupo en storage', e); }
    </script>
    @Scripts.Render("~/bundles/jqueryval")
    <script src="~/Scripts/Docente/Grupos/scriptsAlumnos.js"></script>
    <script src="~/Scripts/Docente/Grupos/scriptsAvisos.js"></script>
    <script src="~/Scripts/Docente/Grupos/scriptsActividades.js"></script>
    <script src="~/Scripts/Docente/Grupos/DetalleMateria.js"></script>
}

<div class="modal fade" id="entregablesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Entregables</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p>Aún no hay entregables configurados.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // abrir modal de entregables
    function abrirEntregables() {
        var modalEl = document.getElementById('entregablesModal');
        if (!modalEl) return;
        var modal = new bootstrap.Modal(modalEl);
        modal.show();
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Guardar nombre y descripcion con botones individuales
        const btnGuardarNombre = document.getElementById('btnGuardarNombre');
        const btnGuardarDescripcion = document.getElementById('btnGuardarDescripcion');

        async function guardarConfig() {
            const nombre = document.getElementById('configNombre').value.trim();
            const descripcion = document.getElementById('configDescripcion').value.trim();
            if (!nombre) { Swal.fire('Error', 'El nombre es requerido', 'error'); return false; }
            try {
                const resp = await fetch(`/Materias/ActualizarMateria?materiaId=${materiaIdGlobal}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ NombreMateria: nombre, Descripcion: descripcion })
                });
                if (resp.ok) { Swal.fire({ position: 'top-end', icon: 'success', title: 'Guardado', showConfirmButton: false, timer: 1500 }); return true; }
                else { Swal.fire('Error', 'No se pudo guardar', 'error'); return false; }
            } catch (e) { console.error(e); Swal.fire('Error', 'No se pudo guardar', 'error'); return false; }
        }

        if (btnGuardarNombre) btnGuardarNombre.addEventListener('click', function () { guardarConfig(); });
        if (btnGuardarDescripcion) btnGuardarDescripcion.addEventListener('click', function () { guardarConfig(); });

        // rellenar inputs de configuracion con datos actuales
        fetch(`/Materias/ObtenerMateriaUnica?id=${materiaIdGlobal}`).then(r => r.json()).then(data => {
            if (data && data.NombreMateria) {
                document.getElementById('configNombre').value = data.NombreMateria || '';
                document.getElementById('configDescripcion').value = data.Descripcion || '';
            }
        }).catch(()=>{});
        // Configuración actions
        const btnEliminar = document.getElementById('btnEliminarMateria');
        const btnCopiar = document.getElementById('btnCopiarMateria');
        const btnEditar = document.getElementById('btnEditarMateria');

        if (btnEliminar) btnEliminar.addEventListener('click', async function () {
            if (!confirm('¿Eliminar esta materia? Esta acción no se puede deshacer.')) return;
            try {
                const resp = await fetch(`/Materias/EliminarMateria?id=${materiaIdGlobal}`, { method: 'DELETE' });
                if (resp.ok) {
                    Swal.fire({ icon: 'success', title: 'Materia eliminada', showConfirmButton: false, timer: 1500 });
                    // redirect to grupos overview
                    window.location.href = '/Docente/Index';
                } else {
                    const txt = await resp.text();
                    Swal.fire('Error', txt || 'No se pudo eliminar la materia', 'error');
                }
            } catch (e) { console.error(e); Swal.fire('Error', 'No se pudo eliminar', 'error'); }
        });

        if (btnCopiar) btnCopiar.addEventListener('click', async function () {
            try {
                // get current materia details
                const respMat = await fetch(`/Materias/ObtenerMateriaUnica?id=${materiaIdGlobal}`);
                if (!respMat.ok) throw new Error('No se pudo obtener materia');
                const mat = await respMat.json();

                // create new materia (sin grupo) copying fields
                const nuevo = { NombreMateria: mat.NombreMateria + ' (Copia)', Descripcion: mat.Descripcion, CodigoColor: mat.CodigoColor || '#2196F3', DocenteId: @docenteId };
                const crear = await fetch('/Materias/CrearMateria', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(nuevo) });
                if (!crear.ok) { const t = await crear.text(); throw new Error(t || 'Error al crear copia'); }
                const res = await crear.json();
                // Inform using native alert and then redirect to Materias sin grupo
                alert("Materia copiada con éxito. Se encuentra en 'Materias sin Grupo'.");
                window.location.href = '/Docente/MateriasSinGrupo';
            } catch (e) { console.error(e); Swal.fire('Error', e.message || 'No se pudo copiar'); }
        });

        if (btnEditar) btnEditar.addEventListener('click', async function () {
            try {
                const nombre = document.getElementById('configNombre').value.trim();
                const descripcion = document.getElementById('configDescripcion').value.trim();
                if (!nombre) { Swal.fire('Error', 'Nombre requerido', 'error'); return; }
                const payload = { MateriaId: materiaIdGlobal, NombreMateria: nombre, Descripcion: descripcion };
                const resp = await fetch(`/Materias/ActualizarMateria?materiaId=${materiaIdGlobal}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (resp.ok) { Swal.fire({ icon: 'success', title: 'Guardado', showConfirmButton: false, timer: 1200 }); }
                else { const txt = await resp.text(); Swal.fire('Error', txt || 'No se pudo guardar', 'error'); }
            } catch (e) { console.error(e); Swal.fire('Error', 'No se pudo guardar', 'error'); }
        });
    });
</script>

@section Styles{
    @Styles.Render("~/Content/Docente/css")
}